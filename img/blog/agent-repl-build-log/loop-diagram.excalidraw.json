{
  "type": "excalidraw",
  "version": 2,
  "source": "https://excalidraw.com",
  "elements": [
    {
      "type": "text",
      "id": "ld-title",
      "x": 220,
      "y": 32,
      "text": "Agent Loop: REPL Within a REPL",
      "fontSize": 38,
      "strokeColor": "#1e1e1e",
      "fontFamily": 1,
      "opacity": 100
    },
    {
      "type": "text",
      "id": "ld-subtitle",
      "x": 190,
      "y": 84,
      "text": "Outer loop handles user turns; inner loop resolves function calls",
      "fontSize": 22,
      "strokeColor": "#475569",
      "fontFamily": 1,
      "opacity": 100
    },
    {
      "type": "rectangle",
      "id": "ld-outer",
      "x": 70,
      "y": 150,
      "width": 1060,
      "height": 700,
      "backgroundColor": "#dbe4ff",
      "fillStyle": "hachure",
      "strokeColor": "#4a9eed",
      "strokeWidth": 1,
      "opacity": 30,
      "roundness": {
        "type": 3
      },
      "strokeStyle": "solid",
      "roughness": 1
    },
    {
      "type": "text",
      "id": "ld-outer-label",
      "x": 100,
      "y": 172,
      "text": "Outer loop",
      "fontSize": 22,
      "strokeColor": "#2563eb",
      "fontFamily": 1,
      "opacity": 100
    },
    {
      "type": "rectangle",
      "id": "ld-user",
      "x": 130,
      "y": 240,
      "width": 240,
      "height": 90,
      "backgroundColor": "#a5d8ff",
      "fillStyle": "hachure",
      "strokeColor": "#4a9eed",
      "roundness": {
        "type": 3
      },
      "label": {
        "text": "1) user prompt\nappend to history",
        "fontSize": 18
      },
      "strokeWidth": 2,
      "strokeStyle": "solid",
      "roughness": 1,
      "opacity": 100
    },
    {
      "type": "rectangle",
      "id": "ld-request",
      "x": 460,
      "y": 240,
      "width": 290,
      "height": 90,
      "backgroundColor": "#d0bfff",
      "fillStyle": "hachure",
      "strokeColor": "#8b5cf6",
      "roundness": {
        "type": 3
      },
      "label": {
        "text": "2) POST /responses\nmodel + tools + input",
        "fontSize": 18
      },
      "strokeWidth": 2,
      "strokeStyle": "solid",
      "roughness": 1,
      "opacity": 100
    },
    {
      "type": "rectangle",
      "id": "ld-stream",
      "x": 840,
      "y": 240,
      "width": 230,
      "height": 90,
      "backgroundColor": "#ffd8a8",
      "fillStyle": "hachure",
      "strokeColor": "#f59e0b",
      "roundness": {
        "type": 3
      },
      "label": {
        "text": "3) stream deltas\nresponse text",
        "fontSize": 18
      },
      "strokeWidth": 2,
      "strokeStyle": "solid",
      "roughness": 1,
      "opacity": 100
    },
    {
      "type": "diamond",
      "id": "ld-decision",
      "x": 520,
      "y": 410,
      "width": 170,
      "height": 150,
      "backgroundColor": "#fff3bf",
      "fillStyle": "hachure",
      "strokeColor": "#f59e0b",
      "label": {
        "text": "tool call\npresent?",
        "fontSize": 20
      },
      "strokeWidth": 2,
      "strokeStyle": "solid",
      "roughness": 1,
      "opacity": 100
    },
    {
      "type": "rectangle",
      "id": "ld-finalize",
      "x": 120,
      "y": 610,
      "width": 280,
      "height": 100,
      "backgroundColor": "#b2f2bb",
      "fillStyle": "hachure",
      "strokeColor": "#22c55e",
      "roundness": {
        "type": 3
      },
      "label": {
        "text": "No -> finalize answer\nwait for next turn",
        "fontSize": 18
      },
      "strokeWidth": 2,
      "strokeStyle": "solid",
      "roughness": 1,
      "opacity": 100
    },
    {
      "type": "rectangle",
      "id": "ld-inner-zone",
      "x": 760,
      "y": 380,
      "width": 330,
      "height": 430,
      "backgroundColor": "#e5dbff",
      "fillStyle": "hachure",
      "strokeColor": "#8b5cf6",
      "strokeWidth": 1,
      "opacity": 35,
      "roundness": {
        "type": 3
      },
      "strokeStyle": "solid",
      "roughness": 1
    },
    {
      "type": "text",
      "id": "ld-inner-label",
      "x": 810,
      "y": 404,
      "text": "Inner tool loop",
      "fontSize": 22,
      "strokeColor": "#6d28d9",
      "fontFamily": 1,
      "opacity": 100
    },
    {
      "type": "rectangle",
      "id": "ld-run-tools",
      "x": 800,
      "y": 460,
      "width": 250,
      "height": 90,
      "backgroundColor": "#c3fae8",
      "fillStyle": "hachure",
      "strokeColor": "#22c55e",
      "roundness": {
        "type": 3
      },
      "label": {
        "text": "4) run handlers\nwith parsed args",
        "fontSize": 18
      },
      "strokeWidth": 2,
      "strokeStyle": "solid",
      "roughness": 1,
      "opacity": 100
    },
    {
      "type": "rectangle",
      "id": "ld-append",
      "x": 800,
      "y": 600,
      "width": 250,
      "height": 90,
      "backgroundColor": "#c3fae8",
      "fillStyle": "hachure",
      "strokeColor": "#22c55e",
      "roundness": {
        "type": 3
      },
      "label": {
        "text": "5) append\ntool output",
        "fontSize": 18
      },
      "strokeWidth": 2,
      "strokeStyle": "solid",
      "roughness": 1,
      "opacity": 100
    },
    {
      "type": "rectangle",
      "id": "ld-repeat",
      "x": 800,
      "y": 730,
      "width": 250,
      "height": 90,
      "backgroundColor": "#c3fae8",
      "fillStyle": "hachure",
      "strokeColor": "#22c55e",
      "roundness": {
        "type": 3
      },
      "label": {
        "text": "6) POST /responses\nagain",
        "fontSize": 18
      },
      "strokeWidth": 2,
      "strokeStyle": "solid",
      "roughness": 1,
      "opacity": 100
    },
    {
      "type": "arrow",
      "id": "ld-a-user-request",
      "x": 370,
      "y": 285,
      "width": 90,
      "height": 0,
      "points": [
        [
          0,
          0
        ],
        [
          90,
          0
        ]
      ],
      "strokeColor": "#1e1e1e",
      "endArrowhead": "arrow",
      "label": {
        "text": "turn",
        "fontSize": 18
      },
      "startBinding": {
        "elementId": "ld-user",
        "fixedPoint": [
          1,
          0.5
        ]
      },
      "endBinding": {
        "elementId": "ld-request",
        "fixedPoint": [
          0,
          0.5
        ]
      },
      "strokeWidth": 2,
      "strokeStyle": "solid",
      "roughness": 1,
      "opacity": 100
    },
    {
      "type": "arrow",
      "id": "ld-a-request-stream",
      "x": 750,
      "y": 285,
      "width": 90,
      "height": 0,
      "points": [
        [
          0,
          0
        ],
        [
          90,
          0
        ]
      ],
      "strokeColor": "#8b5cf6",
      "endArrowhead": "arrow",
      "label": {
        "text": "request",
        "fontSize": 18
      },
      "startBinding": {
        "elementId": "ld-request",
        "fixedPoint": [
          1,
          0.5
        ]
      },
      "endBinding": {
        "elementId": "ld-stream",
        "fixedPoint": [
          0,
          0.5
        ]
      },
      "strokeWidth": 2,
      "strokeStyle": "solid",
      "roughness": 1,
      "opacity": 100
    },
    {
      "type": "arrow",
      "id": "ld-a-stream-decision",
      "x": 955,
      "y": 330,
      "width": -330,
      "height": 80,
      "points": [
        [
          0,
          0
        ],
        [
          -330,
          80
        ]
      ],
      "strokeColor": "#f59e0b",
      "strokeStyle": "dashed",
      "endArrowhead": "arrow",
      "label": {
        "text": "completed output",
        "fontSize": 18
      },
      "startBinding": {
        "elementId": "ld-stream",
        "fixedPoint": [
          0.5,
          1
        ]
      },
      "endBinding": {
        "elementId": "ld-decision",
        "fixedPoint": [
          1,
          0.3
        ]
      },
      "strokeWidth": 2,
      "roughness": 1,
      "opacity": 100
    },
    {
      "type": "arrow",
      "id": "ld-a-decision-no",
      "x": 520,
      "y": 500,
      "width": -120,
      "height": 140,
      "points": [
        [
          0,
          0
        ],
        [
          -120,
          140
        ]
      ],
      "strokeColor": "#22c55e",
      "endArrowhead": "arrow",
      "label": {
        "text": "No",
        "fontSize": 18
      },
      "startBinding": {
        "elementId": "ld-decision",
        "fixedPoint": [
          0,
          0.55
        ]
      },
      "endBinding": {
        "elementId": "ld-finalize",
        "fixedPoint": [
          1,
          0.3
        ]
      },
      "strokeWidth": 2,
      "strokeStyle": "solid",
      "roughness": 1,
      "opacity": 100
    },
    {
      "type": "arrow",
      "id": "ld-a-decision-yes",
      "x": 690,
      "y": 500,
      "width": 110,
      "height": 0,
      "points": [
        [
          0,
          0
        ],
        [
          110,
          0
        ]
      ],
      "strokeColor": "#8b5cf6",
      "endArrowhead": "arrow",
      "label": {
        "text": "Yes",
        "fontSize": 18
      },
      "startBinding": {
        "elementId": "ld-decision",
        "fixedPoint": [
          1,
          0.55
        ]
      },
      "endBinding": {
        "elementId": "ld-run-tools",
        "fixedPoint": [
          0,
          0.4
        ]
      },
      "strokeWidth": 2,
      "strokeStyle": "solid",
      "roughness": 1,
      "opacity": 100
    },
    {
      "type": "arrow",
      "id": "ld-a-run-append",
      "x": 925,
      "y": 550,
      "width": 0,
      "height": 50,
      "points": [
        [
          0,
          0
        ],
        [
          0,
          50
        ]
      ],
      "strokeColor": "#22c55e",
      "endArrowhead": "arrow",
      "startBinding": {
        "elementId": "ld-run-tools",
        "fixedPoint": [
          0.5,
          1
        ]
      },
      "endBinding": {
        "elementId": "ld-append",
        "fixedPoint": [
          0.5,
          0
        ]
      },
      "strokeWidth": 2,
      "strokeStyle": "solid",
      "roughness": 1,
      "opacity": 100
    },
    {
      "type": "arrow",
      "id": "ld-a-append-repeat",
      "x": 925,
      "y": 690,
      "width": 0,
      "height": 40,
      "points": [
        [
          0,
          0
        ],
        [
          0,
          40
        ]
      ],
      "strokeColor": "#22c55e",
      "endArrowhead": "arrow",
      "startBinding": {
        "elementId": "ld-append",
        "fixedPoint": [
          0.5,
          1
        ]
      },
      "endBinding": {
        "elementId": "ld-repeat",
        "fixedPoint": [
          0.5,
          0
        ]
      },
      "strokeWidth": 2,
      "strokeStyle": "solid",
      "roughness": 1,
      "opacity": 100
    },
    {
      "type": "arrow",
      "id": "ld-a-repeat-back",
      "x": 800,
      "y": 780,
      "width": -180,
      "height": -270,
      "points": [
        [
          0,
          0
        ],
        [
          -180,
          -270
        ]
      ],
      "strokeColor": "#8b5cf6",
      "strokeStyle": "dashed",
      "endArrowhead": "arrow",
      "label": {
        "text": "loop back",
        "fontSize": 18
      },
      "startBinding": {
        "elementId": "ld-repeat",
        "fixedPoint": [
          0,
          0.5
        ]
      },
      "endBinding": {
        "elementId": "ld-decision",
        "fixedPoint": [
          1,
          0.75
        ]
      },
      "strokeWidth": 2,
      "roughness": 1,
      "opacity": 100
    },
    {
      "type": "arrow",
      "id": "ld-a-finalize-back",
      "x": 120,
      "y": 660,
      "width": 10,
      "height": -330,
      "points": [
        [
          0,
          0
        ],
        [
          10,
          -330
        ]
      ],
      "strokeColor": "#4a9eed",
      "endArrowhead": "arrow",
      "label": {
        "text": "next prompt",
        "fontSize": 18
      },
      "startBinding": {
        "elementId": "ld-finalize",
        "fixedPoint": [
          0,
          0.5
        ]
      },
      "endBinding": {
        "elementId": "ld-user",
        "fixedPoint": [
          0,
          0.5
        ]
      },
      "strokeWidth": 2,
      "strokeStyle": "solid",
      "roughness": 1,
      "opacity": 100
    },
    {
      "type": "text",
      "id": "ld-user__labelText",
      "x": 171,
      "y": 262,
      "text": "1) user prompt\nappend to history",
      "fontSize": 18,
      "strokeColor": "#4a9eed",
      "fontFamily": 1,
      "opacity": 100
    },
    {
      "type": "text",
      "id": "ld-request__labelText",
      "x": 507,
      "y": 262,
      "text": "2) POST /responses\nmodel + tools + input",
      "fontSize": 18,
      "strokeColor": "#8b5cf6",
      "fontFamily": 1,
      "opacity": 100
    },
    {
      "type": "text",
      "id": "ld-stream__labelText",
      "x": 880,
      "y": 262,
      "text": "3) stream deltas\nresponse text",
      "fontSize": 18,
      "strokeColor": "#f59e0b",
      "fontFamily": 1,
      "opacity": 100
    },
    {
      "type": "text",
      "id": "ld-decision__labelText",
      "x": 538,
      "y": 460,
      "text": "tool call\npresent?",
      "fontSize": 20,
      "strokeColor": "#f59e0b",
      "fontFamily": 1,
      "opacity": 100
    },
    {
      "type": "text",
      "id": "ld-finalize__labelText",
      "x": 162,
      "y": 637,
      "text": "No -> finalize answer\nwait for next turn",
      "fontSize": 18,
      "strokeColor": "#22c55e",
      "fontFamily": 1,
      "opacity": 100
    },
    {
      "type": "text",
      "id": "ld-run-tools__labelText",
      "x": 850,
      "y": 482,
      "text": "4) run handlers\nwith parsed args",
      "fontSize": 18,
      "strokeColor": "#22c55e",
      "fontFamily": 1,
      "opacity": 100
    },
    {
      "type": "text",
      "id": "ld-append__labelText",
      "x": 832,
      "y": 622,
      "text": "5) append\ntool output",
      "fontSize": 18,
      "strokeColor": "#22c55e",
      "fontFamily": 1,
      "opacity": 100
    },
    {
      "type": "text",
      "id": "ld-repeat__labelText",
      "x": 841,
      "y": 752,
      "text": "6) POST /responses\nagain",
      "fontSize": 18,
      "strokeColor": "#22c55e",
      "fontFamily": 1,
      "opacity": 100
    },
    {
      "type": "text",
      "id": "ld-a-user-request__labelText",
      "x": 392,
      "y": 258,
      "text": "turn",
      "fontSize": 18,
      "strokeColor": "#1e1e1e",
      "fontFamily": 1,
      "opacity": 100
    },
    {
      "type": "text",
      "id": "ld-a-request-stream__labelText",
      "x": 758,
      "y": 258,
      "text": "request",
      "fontSize": 18,
      "strokeColor": "#8b5cf6",
      "fontFamily": 1,
      "opacity": 100
    },
    {
      "type": "text",
      "id": "ld-a-stream-decision__labelText",
      "x": 712,
      "y": 344,
      "text": "completed output",
      "fontSize": 18,
      "strokeColor": "#f59e0b",
      "fontFamily": 1,
      "opacity": 100
    },
    {
      "type": "text",
      "id": "ld-a-decision-no__labelText",
      "x": 434,
      "y": 548,
      "text": "No",
      "fontSize": 18,
      "strokeColor": "#22c55e",
      "fontFamily": 1,
      "opacity": 100
    },
    {
      "type": "text",
      "id": "ld-a-decision-yes__labelText",
      "x": 720,
      "y": 474,
      "text": "Yes",
      "fontSize": 18,
      "strokeColor": "#8b5cf6",
      "fontFamily": 1,
      "opacity": 100
    },
    {
      "type": "text",
      "id": "ld-a-repeat-back__labelText",
      "x": 660,
      "y": 620,
      "text": "loop back",
      "fontSize": 18,
      "strokeColor": "#8b5cf6",
      "fontFamily": 1,
      "opacity": 100
    },
    {
      "type": "text",
      "id": "ld-a-finalize-back__labelText",
      "x": 66,
      "y": 470,
      "text": "next prompt",
      "fontSize": 18,
      "strokeColor": "#4a9eed",
      "fontFamily": 1,
      "opacity": 100
    }
  ],
  "appState": {
    "viewBackgroundColor": "#ffffff",
    "exportWithDarkMode": false
  },
  "files": {}
}
