# Blog Feature Plan And Authoring Spec

Status: Phase 3 (tweet embeds) implemented on 2026-02-21.

## Goals

- Keep the blog simple to author while supporting arbitrarily long, mixed-content posts.
- Support text, headers, images, GIFs, diagram images (PNG/WebP/JPG), code snippets, and tweet embeds.
- Keep everything static and generated by the existing TypeScript build pipeline (`scripts/build.ts`).
- Define a stable authoring contract so agents from other repos can generate post entries safely.

## Current Scope

- Blog index page: `blog/index.html`.
- Blog post pages: `blog/<slug>/index.html`.
- Content blocks:
  - `paragraph`
  - `heading`
  - `image`
  - `code`
  - `tweet`
- Inline markdown-style links in paragraph text: `[label](https://example.com)`.
- Static syntax highlighting via Shiki with light/dark theme support.

Out of scope for now:

- RSS feed.
- Full markdown parser.
- CMS/editor UI.

## Content Model

```ts
export type BlogBlock =
    | {
          type: "paragraph";
          text: string;
      }
    | {
          type: "heading";
          level: 2 | 3 | 4;
          text: string;
      }
    | {
          type: "image";
          src: string; // local (/img/blog/...) or https URL
          alt: string;
          caption?: string;
      }
    | {
          type: "code";
          language: string; // validated against supported aliases/languages
          code: string;
          caption?: string;
      }
    | {
          type: "tweet";
          url: string; // twitter.com/x.com status URL
          caption?: string;
      };

export type BlogPost = {
    slug: string; // kebab-case, unique
    title: string;
    summary: string; // used in blog index cards + meta description
    publishedAt: string; // YYYY-MM-DD
    published: boolean; // false keeps the post out of default build output
    heroImage?: string; // optional social/share image
    tags?: string[];
    blocks: BlogBlock[]; // unlimited length
};
```

## Repo Structure

- `content/blog-posts/<slug>.ts`
  - One `BlogPost` export per post file.
- `content/blog-posts/index.ts`
  - Aggregates post exports and defines `blogPosts` ordering.
- `content/site-content.ts`
  - Build entrypoint that re-exports `blogPosts` and shared types.
- `img/blog/<slug>/...`
  - Stores post images, GIFs, and diagrams.
- `blog/<slug>/index.html` (generated)

## Rendering Rules

- Render blocks in order; no max block count.
- `paragraph` -> `<p>` with inline markdown-link conversion.
- `heading` -> `<h2>/<h3>/<h4>` by level.
- `image` -> `<figure><img/><figcaption/></figure>` when caption exists.
- `code` -> static highlighted HTML using Shiki.
- `tweet` -> `<blockquote class="twitter-tweet">` plus one widgets script per page (when present).
  - Light theme: `catppuccin-latte`
  - Dark theme: `catppuccin-mocha`
- GIFs are standard image blocks (`<img>`).
- Every image requires non-empty `alt`.

## Build And Validation Rules

`scripts/build.ts` validates:

- Unique, valid slugs.
- Valid `publishedAt` (`YYYY-MM-DD`).
- Non-empty title, summary, and blocks.
- Local image paths exist and are files.
- Inline markdown links in paragraph text are valid.
- Code block language is supported.
- Tweet block URLs are valid `twitter.com` / `x.com` status links.
- Each post includes a share image source (`heroImage` or at least one `image` block).
- Generated internal `href` / `src` / `srcset` references resolve.

Filtering behavior:

- Default `bun run build` includes only posts with `published: true`.
- `BLOG_INCLUDE_UNPUBLISHED=true bun run build` includes both published and unpublished posts.
- `npm run dev` sets `BLOG_INCLUDE_UNPUBLISHED=true` automatically for local drafting.

### Excalidraw Diagram Asset Flow

Use the helper command to convert MCP checkpoint JSON into blog assets:

```bash
bun run excalidraw:asset -- --input /tmp/diagram.json --slug <slug> --name <asset-name>
```

Outputs:

- `img/blog/<slug>/<asset-name>.excalidraw.json` (source of truth)
- `img/blog/<slug>/<asset-name>.svg` (native Excalidraw style export)
- `img/blog/<slug>/<asset-name>.png` (default output)

Default style preset: `handdrawn-soft` (applied automatically)

- Shape fill style: `hachure` (least-filled hand-drawn look)
- Text font family: hand-drawn style
- Arrow/line sloppiness: medium

Skip PNG generation:

```bash
bun run excalidraw:asset -- --input /tmp/diagram.json --slug <slug> --name <asset-name> --no-png
```

Disable style preset:

```bash
bun run excalidraw:asset -- --input /tmp/diagram.json --slug <slug> --name <asset-name> --no-style-preset
```

Text rendering reliability note:

- Prefer explicit `text` elements for diagram node captions.
- Do not rely only on shape `label` values for critical text.
- If generated PNG/SVG assets show unlabeled boxes, move those labels into standalone
  `text` elements in the checkpoint JSON and rerun `bun run excalidraw:asset`.

You can then reference the generated `.png` (or `.svg`) via an `image` block in the matching post file under `content/blog-posts/`.

### Excalidraw MCP Runbook (Team)

Use this when creating blog diagrams through Codex + Excalidraw MCP.

1. Confirm MCP is connected in Codex.
2. Ask Codex to call `mcp__excalidraw__read_me` first.
3. Build the scene with `mcp__excalidraw__create_view` using Excalidraw elements JSON.
4. Save the checkpoint with `mcp__excalidraw__save_checkpoint` (keep the checkpoint id).
5. Read the full checkpoint JSON with `mcp__excalidraw__read_checkpoint`.
   Important: ensure diagram node captions are explicit `text` elements in the scene JSON.
   Do not rely only on shape `label` values for text you need in exported PNG/SVG assets.
6. Pipe or save that JSON and run:

```bash
bun run excalidraw:asset -- --input /tmp/diagram.json --slug <slug> --name <asset-name>
```

7. Add the generated image to the matching post file in `content/blog-posts/`:

```ts
{
    type: "image",
    src: "/img/blog/<slug>/<asset-name>.png",
    alt: "Meaningful description of the diagram",
    caption: "Optional caption",
}
```

8. Run:
   - `bun run build`
   - `npm run typecheck`

9. Commit:
   - `img/blog/<slug>/<asset-name>.excalidraw.json` (editable source)
   - `img/blog/<slug>/<asset-name>.png` (primary blog asset)
   - `img/blog/<slug>/<asset-name>.svg` (optional but recommended for source fidelity)

10. Optional: publish a live-edit link by exporting with `mcp__excalidraw__export_to_excalidraw`.

#### Troubleshooting: Missing Labels In Exported PNG/SVG

- Symptom: boxes/arrows render, but node labels are missing in generated blog assets.
- Cause: scene relies on shape `label` values that may not survive all export paths reliably.
- Fix: convert those labels into standalone `text` elements, then rerun:

```bash
bun run excalidraw:asset -- --input /tmp/diagram.json --slug <slug> --name <asset-name>
```

#### Reusable Example Pattern

Use this share-link format when you want a re-editable source attached to a post:

- `https://excalidraw.com/#json=<scene-id>,<scene-key>`

Recommended authoring flow:

1. Keep the share link in your notes/PR description.
2. Store the exported source in repo as:
   - `img/blog/<slug>/<asset-name>.excalidraw.json`
3. Regenerate blog-safe assets any time with:

```bash
bun run excalidraw:asset -- --input img/blog/<slug>/<asset-name>.excalidraw.json --slug <slug> --name <asset-name>
```

#### Styling For A More Hand-Drawn Look

When creating elements, bias toward these values:

- `roughness: 1` for medium sloppiness (default preset target)
- `fillStyle: "hachure"` for least-filled style (default preset target)
- `fillStyle: "cross-hatch"` for denser fills
- `strokeStyle: "dashed"` where appropriate
- slightly irregular line points for arrows/lines instead of perfect straight geometry

## Supported Code Languages

Current supported normalized languages:

- `ts`
- `tsx`
- `js`
- `jsx`
- `json`
- `bash`

Current accepted aliases:

- `typescript` -> `ts`
- `javascript` -> `js`
- `sh` -> `bash`
- `shell` -> `bash`

## Agent Authoring Contract

When generating a new blog post from another repo/agent:

1. Create or reuse image assets in `img/blog/<slug>/`.
2. Add one `BlogPost` export in `content/blog-posts/<slug>.ts` with `published: false` while drafting, then include it in `content/blog-posts/index.ts` `blogPosts` ordering.
3. Use supported block types (`paragraph`, `heading`, `image`, `code`, `tweet`).
4. Keep paragraphs plain text with optional inline markdown links.
5. Ensure every image has meaningful `alt`.
6. For code blocks, use a supported language value (or alias).
7. Run:
   - `bun run build`
   - `npm run typecheck`

## Copy/Paste Template For New Posts

```ts
{
    slug: "descriptive-kebab-slug",
    title: "Post Title",
    summary: "One-sentence summary for cards and metadata.",
    publishedAt: "2026-02-16",
    published: false,
    heroImage: "/img/blog/descriptive-kebab-slug/hero.png",
    tags: ["engineering"],
    blocks: [
        {
            type: "paragraph",
            text: "Intro paragraph with an optional [link](https://example.com).",
        },
        {
            type: "heading",
            level: 2,
            text: "Section Heading",
        },
        {
            type: "tweet",
            url: "https://twitter.com/threepointone/status/2020043852317417970",
            caption: "Optional caption for context around the embed.",
        },
        {
            type: "paragraph",
            text: "More body content.",
        },
        {
            type: "image",
            src: "/img/blog/descriptive-kebab-slug/system-diagram.png",
            alt: "System diagram showing request flow from client to API.",
            caption: "Request flow for the blog publish pipeline.",
        },
        {
            type: "code",
            language: "ts",
            caption: "Example typed payload.",
            code: `type Payload = {
    id: string;
    title: string;
};`,
        },
    ],
}
```
